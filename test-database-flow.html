<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Flow Test - Teppek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-2xl font-bold mb-4">ğŸ§ª Database Flow Test</h1>
            <p class="text-gray-600 mb-4">20 Ã¼lkeden son 7 gÃ¼nÃ¼n iÅŸ ilanlarÄ±nÄ± database'e yÃ¼kleyip test edin</p>
            
            <!-- Test AdÄ±mlarÄ± -->
            <div class="space-y-4">
                
                <!-- AdÄ±m 1: Database Tablosu Kontrol -->
                <div class="border border-gray-300 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-2">1ï¸âƒ£ Database Tablosu Kontrol</h2>
                    <p class="text-sm text-gray-600 mb-2">Ã–nce Supabase'de jobs tablosunun oluÅŸturulup oluÅŸturulmadÄ±ÄŸÄ±nÄ± kontrol edin</p>
                    <button onclick="testDatabase()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fa-solid fa-database"></i> Database Test Et
                    </button>
                    <div id="db-result" class="mt-2"></div>
                </div>

                <!-- AdÄ±m 2: Bulk Veri YÃ¼kleme -->
                <div class="border border-gray-300 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-2">2ï¸âƒ£ Bulk Veri YÃ¼kleme (20 Ãœlke)</h2>
                    <p class="text-sm text-gray-600 mb-2">Adzuna'dan son 7 gÃ¼nÃ¼n ilanlarÄ±nÄ± Ã§ekip database'e kaydet</p>
                    <button onclick="loadBulkData()" id="bulk-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fa-solid fa-download"></i> Bulk Veri YÃ¼kle (~10,000 ilan)
                    </button>
                    <div id="bulk-result" class="mt-2"></div>
                </div>

                <!-- AdÄ±m 3: Veri Okuma Testi -->
                <div class="border border-gray-300 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-2">3ï¸âƒ£ Database'den Veri Okuma</h2>
                    <p class="text-sm text-gray-600 mb-2">YÃ¼klenen verileri database'den okuyup listele</p>
                    <button onclick="testDataRead()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        <i class="fa-solid fa-list"></i> Verileri Oku
                    </button>
                    <div id="read-result" class="mt-2"></div>
                </div>

                <!-- AdÄ±m 4: Ä°statistikler -->
                <div class="border border-gray-300 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-2">4ï¸âƒ£ Ä°statistikler</h2>
                    <div id="stats-result" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Log Area -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-4">
            <h3 class="text-lg font-mono mb-2">ğŸ“‹ Test LoglarÄ±</h3>
            <div id="logs" class="font-mono text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://teppek.com/api';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Database baÄŸlantÄ± testi
        async function testDatabase() {
            log('ğŸ§ª Database baÄŸlantÄ±sÄ± test ediliyor...');
            document.getElementById('db-result').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Test ediliyor...';
            
            try {
                const response = await fetch(`${API_BASE}/db-test`);
                const result = await response.json();
                
                if (result.success) {
                    log('âœ… Database baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±');
                    document.getElementById('db-result').innerHTML = '<span class="text-green-600">âœ… BaÄŸlantÄ± baÅŸarÄ±lÄ±</span>';
                } else {
                    log('âŒ Database hatasÄ±: ' + result.error);
                    document.getElementById('db-result').innerHTML = '<span class="text-red-600">âŒ ' + result.error + '</span>';
                }
            } catch (error) {
                log('âŒ Network hatasÄ±: ' + error.message);
                document.getElementById('db-result').innerHTML = '<span class="text-red-600">âŒ ' + error.message + '</span>';
            }
        }

        // Bulk veri yÃ¼kleme
        async function loadBulkData() {
            log('ğŸŒ Bulk veri yÃ¼kleme baÅŸlatÄ±lÄ±yor...');
            const btn = document.getElementById('bulk-btn');
            const resultDiv = document.getElementById('bulk-result');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...';
            resultDiv.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 20 Ã¼lkeden veri Ã§ekiliyor...';
            
            try {
                // TÃ¼m 20 Ã¼lke, son 7 gÃ¼n, 10 sayfa
                const url = `${API_BASE}/load-data?countries=gb,us,de,fr,ca,au,nl,it,es,sg,at,be,br,ch,in,mx,nz,pl,ru,za&days=7&pages=10`;
                log('ğŸ“ API Ã§aÄŸrÄ±sÄ±: ' + url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… Bulk yÃ¼kleme tamamlandÄ±: ${result.summary.total_inserted} ilan`);
                    log(`ğŸ“Š API Ã§aÄŸrÄ± sayÄ±sÄ±: ${result.summary.api_calls}`);
                    log(`ğŸŒ Ä°ÅŸlenen Ã¼lkeler: ${Object.keys(result.summary.by_country).length}`);
                    
                    let breakdown = 'ğŸ“ˆ Ãœlke daÄŸÄ±lÄ±mÄ±:\n';
                    Object.entries(result.summary.by_country)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([country, count]) => {
                            breakdown += `  ${country.toUpperCase()}: ${count} ilan\n`;
                        });
                    log(breakdown);
                    
                    resultDiv.innerHTML = `<span class="text-green-600">âœ… ${result.summary.total_inserted} ilan yÃ¼klendi</span>`;
                } else {
                    log('âŒ Bulk yÃ¼kleme hatasÄ±: ' + result.error);
                    resultDiv.innerHTML = '<span class="text-red-600">âŒ ' + result.error + '</span>';
                }
            } catch (error) {
                log('âŒ Network hatasÄ±: ' + error.message);
                resultDiv.innerHTML = '<span class="text-red-600">âŒ ' + error.message + '</span>';
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-download"></i> Bulk Veri YÃ¼kle (~10,000 ilan)';
        }

        // Veri okuma testi
        async function testDataRead() {
            log('ğŸ“– Database\'den veri okuma testi...');
            document.getElementById('read-result').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Okunuyor...';
            
            try {
                const response = await fetch(`${API_BASE}/get-jobs?limit=100&page=1`);
                const result = await response.json();
                
                if (result.success && result.jobs) {
                    log(`âœ… ${result.jobs.length} ilan baÅŸarÄ±yla okundu`);
                    log(`ğŸ“Š Toplam: ${result.stats.total_jobs} ilan`);
                    log(`ğŸ“„ ${result.stats.current_page}/${result.stats.total_pages} sayfa`);
                    
                    // Ä°statistikleri hesapla
                    const jobs = result.jobs;
                    const remoteCount = jobs.filter(job => job.remote).length;
                    const withSalaryCount = jobs.filter(job => job.salary_min || job.salary_max).length;
                    
                    const countryStats = {};
                    jobs.forEach(job => {
                        countryStats[job.country] = (countryStats[job.country] || 0) + 1;
                    });
                    
                    let statsHtml = `
                        <span class="text-green-600">âœ… ${result.jobs.length} ilan okundu</span><br>
                        <span class="text-sm text-gray-600">
                            ğŸ  Remote: ${remoteCount} | ğŸ’° MaaÅŸlÄ±: ${withSalaryCount} | ğŸŒ Ãœlkeler: ${Object.keys(countryStats).length}
                        </span>
                    `;
                    document.getElementById('read-result').innerHTML = statsHtml;
                    
                    // Ana istatistikler panelini gÃ¼ncelle
                    let detailedStats = `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="text-blue-800 font-semibold">Toplam Ä°lan</div>
                                <div class="text-2xl font-bold text-blue-600">${result.stats.total_jobs}</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-green-800 font-semibold">Remote Ä°ÅŸler</div>
                                <div class="text-2xl font-bold text-green-600">${remoteCount}</div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <div class="text-purple-800 font-semibold">MaaÅŸlÄ± Ä°lanlar</div>
                                <div class="text-2xl font-bold text-purple-600">${withSalaryCount}</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded">
                                <div class="text-orange-800 font-semibold">Aktif Ãœlkeler</div>
                                <div class="text-2xl font-bold text-orange-600">${Object.keys(countryStats).length}</div>
                            </div>
                        </div>
                        <div class="mt-4 text-sm">
                            <strong>En Ã‡ok Ä°lan Olan Ãœlkeler:</strong><br>
                            ${Object.entries(countryStats)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 5)
                                .map(([country, count]) => `${country}: ${count}`)
                                .join(' | ')}
                        </div>
                    `;
                    document.getElementById('stats-result').innerHTML = detailedStats;
                } else {
                    log('âš ï¸ Database\'de veri bulunamadÄ±');
                    document.getElementById('read-result').innerHTML = '<span class="text-yellow-600">âš ï¸ Veri bulunamadÄ±</span>';
                }
            } catch (error) {
                log('âŒ Veri okuma hatasÄ±: ' + error.message);
                document.getElementById('read-result').innerHTML = '<span class="text-red-600">âŒ ' + error.message + '</span>';
            }
        }

        // Sayfa yÃ¼klendiÄŸinde database testi yap
        window.onload = () => {
            log('ğŸš€ Test sayfasÄ± yÃ¼klendi');
            testDatabase();
        };
    </script>
</body>
</html>