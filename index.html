<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konum Tabanlı İş İlanı Platformu - Prototip</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Kütüphaneleri -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (JSX'i tarayıcıda çalıştırmak için) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet.js (OpenStreetMap için Harita Kütüphanesi) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster Kütüphanesi -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Font Awesome (İkonlar için) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* Sayfanın tamamını kaplaması için temel stiller */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Ana sayfada kaydırmayı engelle */
            font-family: 'Inter', sans-serif;
        }
        /* Harita konteynerinin boyutunu belirle */
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
        /* Özel renklerimizi Tailwind'e ekleyelim */
        .bg-ilan { background-color: #0097A7; } /* Turkuaz */
        .text-ilan { color: #0097A7; }
        .border-ilan { border-color: #0097A7; }
        .bg-cv { background-color: #FB8C00; } /* Turuncu */
        .text-cv { color: #FB8C00; }
        .border-cv { border-color: #FB8C00; }

        /* Mobil panel animasyonu için */
        .bottom-sheet {
            transition: transform 0.3s ease-in-out;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 1px;
        }
        .leaflet-popup-content {
            margin: 0 !important;
            width: 280px !important;
            font-size: 14px;
            line-height: 1.5;
        }
        .custom-popup-container {
            padding: 16px;
        }

        .marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 120px; /* Etiket için genişlik */
        }
        .marker-container .icon-wrapper {
            position: relative; /* Yıldız ikonu için */
            font-size: 20px;
            background-color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 3px solid; /* Renk inline olarak atanacak */
            transition: transform 0.2s;
        }
        .marker-label {
            font-size: 12px;
            font-weight: bold;
            color: #374151; /* gray-700 */
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 6px;
            margin-top: 6px;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sponsored-marker .icon-wrapper {
            width: 60px; /* Daha büyük ikon */
            height: 60px;
            font-size: 26px; /* Daha büyük ikon içeriği */
            border-width: 4px;
        }
        .sponsored-marker .icon-wrapper::before {
            content: '';
            position: absolute;
            left: -15px;
            top: -15px;
            width: 90px;
            height: 90px;
            background-color: #FBBF24; /* Opak Sarı */
            border-radius: 50%;
            z-index: -1;
        }
        
        .user-location-icon {
            font-size: 32px; /* İkon boyutu */
            color: #2563EB; /* blue-600 */
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- API BAĞLANTILARI ---
        // Supabase Dashboard > Settings > API'den alın
        const SUPABASE_URL = 'https://fcsggaggjtxqwatimplk.supabase.co'; // https://xxxxx.supabase.co şeklinde
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjc2dnYWdnanR4cXdhdGltcGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTg2MzAsImV4cCI6MjA3MTM3NDYzMH0.VKTZTVSqBvzVrP8pabPqFfAetfMjZSj45YwkXPOM9Bg'; // eyJ... ile başlayan uzun key
        
        // Adzuna Developer Dashboard'dan alın
        const ADZUNA_APP_ID = 'a19dd595';
        const ADZUNA_APP_KEY = '0f8160edaa39c3dcac3962d77b32236b';
        
        // Supabase client oluştur
        let supabase = null;
        
        // Supabase bağlantısını kur
        try {
            if (typeof window !== 'undefined' && window.supabase) {
                const { createClient } = window.supabase;
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase bağlantısı başarılı!');
                
                // Test için veri çek
                testSupabaseConnection();
            } else {
                console.log('⏳ Supabase yükleniyor...');
                // 2 saniye sonra tekrar dene
                setTimeout(() => {
                    if (window.supabase) {
                        const { createClient } = window.supabase;
                        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('✅ Supabase bağlantısı kuruldu!');
                        testSupabaseConnection();
                    }
                }, 2000);
            }
        } catch (error) {
            console.error('Supabase hatası:', error);
        }
        
        // Supabase bağlantısını test et
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('listings')
                    .select('count')
                    .limit(1);
                    
                if (error) {
                    console.log('⚠️ Tablo henüz oluşturulmamış olabilir:', error.message);
                } else {
                    console.log('✅ Database bağlantısı başarılı!');
                }
            } catch (err) {
                console.error('Test hatası:', err);
            }
        }

        // --- BAŞLANGIÇ VERİLERİ (PROTOTİP İÇİN) ---
        const initialData = []; // Test verileri kaldırıldı - sadece API'den gelecek
        
        const getDistance = (lat1, lon1, lat2, lon2) => {
            if (!lat1 || !lon1 || !lat2 || !lon2) return Infinity;
            const R = 6371; // Dünya'nın yarıçapı (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        // --- ANA UYGULAMA BİLEŞENİ ---
        function App() {
            const [data, setData] = useState(initialData);
            const [activeFilters, setActiveFilters] = useState({ type: 'all', keyword: '' });
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [isMobilePanelOpen, setIsMobilePanelOpen] = useState(false);
            const [isMobileFormOpen, setIsMobileFormOpen] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [isSubscribed, setIsSubscribed] = useState(false);
            const [showSubscriptionModal, setShowSubscriptionModal] = useState(false);
            
            const itemsPerPage = 50;
            const [userLocation, setUserLocation] = useState(null);

            useEffect(() => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        setUserLocation({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        });
                    },
                    (error) => {
                        console.error("Konum alınamadı:", error);
                        setUserLocation({ lat: 41.01, lng: 28.97 });
                    }
                );
            }, []);

            // API'den veri çek
            useEffect(() => {
                if (!userLocation || !userLocation.lat || !userLocation.lng) {
                    return; // Konum bilgisi yoksa bekleme
                }
                
                const fetchListings = async () => {
                    try {
                        console.log('🌍 Database\'den iş ilanları yükleniyor...');
                        
                        // Database'den iş ilanlarını çek
                        const response = await fetch(`https://teppek.com/api/get-jobs?limit=1000&page=1`);
                        const result = await response.json();
                        
                        if (result.success && result.jobs && result.jobs.length > 0) {
                            console.log(`✅ ${result.jobs.length} adet iş ilanı yüklendi!`);
                            console.log(`📊 Database İstatistikleri:`, result.stats);
                            console.log(`🌍 Toplam: ${result.stats.total_jobs} ilan`);
                            console.log(`📄 Sayfa: ${result.stats.current_page}/${result.stats.total_pages}`);
                            
                            // Database mapping - Popup için tüm alanlar
                            const formattedJobs = result.jobs.map(job => ({
                                id: `db-${job.id}`,
                                type: 'job',
                                title: job.title,
                                company: job.company || 'Şirket Belirtilmemiş',
                                location: {
                                    lat: parseFloat(job.lat),
                                    lng: parseFloat(job.lon)
                                },
                                address: `${job.city || ''}, ${job.country || ''}`.replace(/^,\s*|,\s*$/g, ''),
                                description: job.description || `${job.title} pozisyonu için açıklama mevcut değil.`,
                                salary_min: job.salary_min,
                                salary_max: job.salary_max,
                                currency: job.currency,
                                applyUrl: job.url,
                                source: 'adzuna',
                                isRemote: job.remote,
                                postedDate: job.created_at
                            })).filter(job => job.location.lat && job.location.lng);
                            
                            console.log(`🗺️ Haritada gösterilecek: ${formattedJobs.length} ilan`);
                            
                            // Remote ilanları say
                            const remoteCount = formattedJobs.filter(job => job.isRemote).length;
                            console.log(`🏠 Remote ilanlar: ${remoteCount}`);
                            
                            // Ülkelere göre dağılım
                            const countryStats = {};
                            formattedJobs.forEach(job => {
                                const country = job.address.split(',').pop().trim();
                                countryStats[country] = (countryStats[country] || 0) + 1;
                            });
                            console.log(`🌍 Ülke dağılımı:`, countryStats);
                            
                            // Verileri set et
                            setData(prevData => [...prevData, ...formattedJobs]);
                        } else {
                            console.log('⚠️ Database\'de henüz veri yok. Önce /api/load-data çağırın.');
                        }
                    } catch (error) {
                        console.error('Database API hatası:', error);
                        console.log('💡 Database bağlantısı kurulamadı. Supabase ayarlarını kontrol edin.');
                    }
                };
                
                fetchListings();
            }, [userLocation]);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            
            const processedData = useMemo(() => {
                if (!userLocation) return [];

                const filtered = data.filter(item => {
                    const typeMatch = activeFilters.type === 'all' || item.type === activeFilters.type;
                    const keywordMatch = activeFilters.keyword === '' || 
                                         item.title.toLowerCase().includes(activeFilters.keyword.toLowerCase()) ||
                                         (item.company && item.company.toLowerCase().includes(activeFilters.keyword.toLowerCase())) ||
                                         (item.name && item.name.toLowerCase().includes(activeFilters.keyword.toLowerCase()));
                    return typeMatch && keywordMatch;
                });
                
                const sorted = filtered.sort((a, b) => {
                    if (a.isSponsored && !b.isSponsored) return -1;
                    if (!a.isSponsored && b.isSponsored) return 1;
                    
                    const distA = getDistance(userLocation.lat, userLocation.lng, a.location.lat, a.location.lng);
                    const distB = getDistance(userLocation.lat, userLocation.lng, b.location.lat, b.location.lng);
                    const canViewA = isSubscribed || distA <= 50;
                    const canViewB = isSubscribed || distB <= 50;
                    
                    if (canViewA && !canViewB) return -1;
                    if (!canViewA && canViewB) return 1;
                    
                    return distA - distB;
                });

                return sorted;
            }, [data, activeFilters, isSubscribed, userLocation]);
            
            const paginatedData = useMemo(() => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                return processedData.slice(startIndex, endIndex);
            }, [currentPage, processedData]);
            
            const totalPages = Math.ceil(processedData.length / itemsPerPage);

            const handleAddEntry = (entry) => {
                setData(prevData => [{ ...entry, id: Date.now(), isOwner: true, isSponsored: false }, ...prevData]);
                if(isMobile) setIsMobileFormOpen(false);
            };

            const handleRowClick = (location) => {
                setSelectedLocation(location);
                if(isMobile) setIsMobilePanelOpen(false);
            };

            if (!userLocation) {
                return (
                    <div className="h-full w-full flex justify-center items-center bg-gray-100">
                        <div className="text-center">
                            <i className="fa-solid fa-spinner fa-spin text-4xl text-blue-600"></i>
                            <p className="mt-4 text-gray-700">Konumunuz alınıyor...</p>
                        </div>
                    </div>
                );
            }

            return (
                <>
                    {showSubscriptionModal && <SubscriptionModal onClose={() => setShowSubscriptionModal(false)} />}
                    
                    {isMobile ? (
                        // --- MOBİL GÖRÜNÜM ---
                        <div className="h-full w-full relative">
                            <MapComponent data={processedData} selectedLocation={selectedLocation} isSubscribed={isSubscribed} userLocation={userLocation} onPremiumClick={() => setShowSubscriptionModal(true)} />
                            
                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 z-[1000] flex gap-4">
                                <button onClick={() => setIsMobilePanelOpen(true)} className="bg-white text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2">
                                    <i className="fa-solid fa-list"></i> Filtrele & Listele
                                </button>
                            </div>
                            <div className="absolute top-4 right-4 z-[1000]">
                                <button onClick={() => setIsMobileFormOpen(true)} className="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl">
                                    <i className="fa-solid fa-plus"></i>
                                </button>
                            </div>

                            <div className={`absolute bottom-0 left-0 right-0 z-[1001] bg-white rounded-t-2xl shadow-2xl p-4 bottom-sheet ${isMobilePanelOpen ? 'transform translate-y-0' : 'transform translate-y-full'}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Sonuçlar</h2>
                                    <button onClick={() => setIsMobilePanelOpen(false)} className="text-gray-500 text-2xl">&times;</button>
                                </div>
                                <FilterComponent onFilterChange={setActiveFilters} setCurrentPage={setCurrentPage} isSubscribed={isSubscribed} onSubscribeToggle={() => setIsSubscribed(!isSubscribed)} />
                                <ListComponent data={paginatedData} onRowClick={handleRowClick} isSubscribed={isSubscribed} userLocation={userLocation} onPremiumClick={() => setShowSubscriptionModal(true)} />
                                <PaginationComponent currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                            </div>
                            
                            {isMobileFormOpen && (
                               <div className="absolute top-0 left-0 w-full h-full bg-gray-100 z-[1002] p-4 overflow-y-auto">
                                    <div className="flex justify-end items-center mb-4">
                                        <button onClick={() => setIsMobileFormOpen(false)} className="text-gray-500 text-2xl">&times;</button>
                                    </div>
                                    <EntryFormComponent onAddEntry={handleAddEntry} />
                               </div>
                            )}
                        </div>
                    ) : (
                        // --- WEB/MASAÜSTÜ GÖRÜNÜM ---
                        <div className="h-full w-full flex flex-col">
                            <div className="flex h-2/3">
                                <div className="w-[35%] h-full p-4 bg-gray-50 overflow-y-auto">
                                    <EntryFormComponent onAddEntry={handleAddEntry} />
                                </div>
                                <div className="w-[65%] h-full">
                                    <MapComponent data={processedData} selectedLocation={selectedLocation} isSubscribed={isSubscribed} userLocation={userLocation} onPremiumClick={() => setShowSubscriptionModal(true)} />
                                </div>
                            </div>
                            <div className="h-1/3 flex flex-col p-4 border-t bg-white">
                                <FilterComponent onFilterChange={setActiveFilters} setCurrentPage={setCurrentPage} isSubscribed={isSubscribed} onSubscribeToggle={() => setIsSubscribed(!isSubscribed)} />
                                <ListComponent data={paginatedData} onRowClick={handleRowClick} isSubscribed={isSubscribed} userLocation={userLocation} onPremiumClick={() => setShowSubscriptionModal(true)} />
                                <PaginationComponent currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                            </div>
                        </div>
                    )}
                </>
            );
        }
        
        // --- ALT BİLEŞENLER ---

        function EntryFormComponent({ onAddEntry }) {
            const [entryType, setEntryType] = useState('job');
            const [title, setTitle] = useState('');
            const [companyOrName, setCompanyOrName] = useState('');
            const [minSalary, setMinSalary] = useState('');
            const [maxSalary, setMaxSalary] = useState('');
            const [description, setDescription] = useState('');
            const [contactInfo, setContactInfo] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const newEntry = {
                    id: `manual-${Date.now()}`,
                    type: entryType,
                    title,
                    description,
                    location: { lat: 41.0, lng: 29.0 }, 
                    address: 'Yeni Kayıt, İstanbul',
                    source: 'manual', // Manuel eklenen
                    postedDate: new Date().toISOString(),
                    // Popup için ortak alanlar
                    applyUrl: null, // Manuel ilanlarda başvuru linki yok
                    contact: contactInfo, // Sadece manuel ilanlarda var
                };
                if (entryType === 'job') {
                    newEntry.company = companyOrName;
                    newEntry.salary_min = parseInt(minSalary);
                    newEntry.salary_max = parseInt(maxSalary);
                    // Adzuna ile uyumlu ek alanlar
                    newEntry.salary = {
                        min: parseInt(minSalary),
                        max: parseInt(maxSalary),
                        currency: 'TRY',
                        period: 'Aylık'
                    };
                    newEntry.employmentType = 'Tam zamanlı';
                    newEntry.category = 'Genel';
                } else {
                    newEntry.name = companyOrName;
                }
                onAddEntry(newEntry);
                setTitle(''); setCompanyOrName(''); setMinSalary(''); setMaxSalary(''); setDescription(''); setContactInfo('');
            };

            return (
                <div className="flex flex-col h-full">
                    <div className="grid grid-cols-2 gap-2 mb-4">
                        <button onClick={() => setEntryType('job')} className={`p-3 rounded-lg font-semibold ${entryType === 'job' ? 'bg-ilan text-white' : 'bg-gray-200'}`}>İş İlanı</button>
                        <button onClick={() => setEntryType('cv')} className={`p-3 rounded-lg font-semibold ${entryType === 'cv' ? 'bg-cv text-white' : 'bg-gray-200'}`}>Özgeçmiş</button>
                    </div>
                    <form onSubmit={handleSubmit} className="flex-grow flex flex-col">
                        <div className="space-y-3">
                            {entryType === 'job' ? (
                                <>
                                    <input type="text" placeholder="İlan Başlığı (örn: Yazılım Geliştirici)" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 border rounded-md" required />
                                    <textarea placeholder="Açıklama" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-2 border rounded-md h-24" required></textarea>
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="Min Maaş" value={minSalary} onChange={e => setMinSalary(e.target.value)} className="w-1/2 p-2 border rounded-md" required />
                                        <input type="number" placeholder="Max Maaş" value={maxSalary} onChange={e => setMaxSalary(e.target.value)} className="w-1/2 p-2 border rounded-md" required />
                                    </div>
                                    <input type="text" placeholder="Şirket Adı" value={companyOrName} onChange={e => setCompanyOrName(e.target.value)} className="w-full p-2 border rounded-md" required />
                                    <input type="text" placeholder="İletişim Bilgileri (E-posta veya Telefon)" value={contactInfo} onChange={e => setContactInfo(e.target.value)} className="w-full p-2 border rounded-md" required />
                                </>
                            ) : (
                                <>
                                    <input type="text" placeholder="Ad Soyad" value={companyOrName} onChange={e => setCompanyOrName(e.target.value)} className="w-full p-2 border rounded-md" required />
                                    <input type="text" placeholder="Ünvan (örn: Proje Yöneticisi)" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 border rounded-md" required />
                                    <textarea placeholder="Açıklama / Yetenek Özeti" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-2 border rounded-md h-40" required></textarea>
                                    <input type="text" placeholder="İletişim Bilgileri (E-posta veya Telefon)" value={contactInfo} onChange={e => setContactInfo(e.target.value)} className="w-full p-2 border rounded-md" required />
                                </>
                            )}
                        </div>
                        <button type="submit" className="w-full p-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 mt-auto">Ekle</button>
                    </form>
                </div>
            );
        }

        function MapComponent({ data, selectedLocation, isSubscribed, userLocation, onPremiumClick }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const clusterGroupRef = useRef(null);
            const circleRef = useRef(null);
            const userMarkerRef = useRef(null);
            // *** YENİ: Harita katmanları için state ***
            const [tileLayer, setTileLayer] = useState(null);

            const tileProviders = {
                street: { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' },
                satellite: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attribution: 'Tiles &copy; Esri' }
            };

            const changeMapLayer = (layerKey) => {
                if (mapInstance.current && tileLayer) {
                    mapInstance.current.removeLayer(tileLayer);
                }
                const newLayer = L.tileLayer(tileProviders[layerKey].url, {
                    attribution: tileProviders[layerKey].attribution,
                    noWrap: true
                }).addTo(mapInstance.current);
                setTileLayer(newLayer);
            };

            useEffect(() => {
                if (mapRef.current && !mapInstance.current) {
                    mapInstance.current = L.map(mapRef.current).setView([userLocation.lat, userLocation.lng], 10);
                    
                    const initialLayer = L.tileLayer(tileProviders.street.url, {
                        attribution: tileProviders.street.attribution,
                        noWrap: true
                    }).addTo(mapInstance.current);
                    setTileLayer(initialLayer);

                    circleRef.current = L.circle([userLocation.lat, userLocation.lng], {
                        radius: 50000, 
                        color: '#3b82f6',
                        fillColor: '#60a5fa',
                        fillOpacity: 0.1,
                        weight: 1
                    }).addTo(mapInstance.current);

                    if (mapInstance.current) {
                        mapInstance.current.fitBounds(circleRef.current.getBounds());
                    }

                    clusterGroupRef.current = L.markerClusterGroup();
                    mapInstance.current.addLayer(clusterGroupRef.current);
                }
            }, []);

            useEffect(() => {
                if (mapInstance.current && userLocation) {
                    const userIcon = L.divIcon({
                        html: `<i class="fa-solid fa-location-pin user-location-icon"></i>`,
                        className: '',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    });

                    if (circleRef.current) {
                        circleRef.current.setLatLng([userLocation.lat, userLocation.lng]);
                    }
                    if (userMarkerRef.current) {
                        userMarkerRef.current.setLatLng([userLocation.lat, userLocation.lng]);
                    } else {
                        userMarkerRef.current = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(mapInstance.current);
                    }
                }
            }, [userLocation]);

            useEffect(() => {
                if (!clusterGroupRef.current) return;
                clusterGroupRef.current.clearLayers();
                data.forEach(item => {
                    const distance = getDistance(userLocation.lat, userLocation.lng, item.location.lat, item.location.lng);
                    const isPremiumContent = distance > 50;
                    const canView = isSubscribed || !isPremiumContent;

                    const iconClass = item.type === 'job' ? 'fa-briefcase' : 'fa-user';
                    const iconColor = item.type === 'job' ? '#0097A7' : '#FB8C00';
                    const iconHtml = `<div class="marker-container ${item.isSponsored ? 'sponsored-marker' : ''}"><div class="icon-wrapper" style="border-color: ${item.isSponsored ? '#FBBF24' : iconColor};">${item.isSponsored ? '<i class="fa-solid fa-star absolute -top-2 -right-2 text-yellow-400 text-xl"></i>' : ''}<i class="fa-solid ${iconClass}" style="color: ${iconColor};"></i></div><div class="marker-label">${item.title}</div></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [120, 90], iconAnchor: [60, 26] });
                    const marker = L.marker([item.location.lat, item.location.lng], { icon: customIcon });
                    
                    let popupContent;
                    if (canView) {
                        const sponsoredPopupClass = item.isSponsored ? 'bg-yellow-50' : '';
                        // Başvuru butonu - API veya manuel ilana göre
                        let applyButton = '';
                        if (item.applyUrl) {
                            // API'den gelen ilanlar (Adzuna)
                            applyButton = `<a href="${item.applyUrl}" target="_blank" rel="noopener noreferrer" 
                               style="display: block; width: 100%; background-color: #2563eb; color: white; font-weight: bold; padding: 10px 16px; border-radius: 8px; text-align: center; margin-top: 12px; text-decoration: none; transition: background-color 0.3s;"
                               onmouseover="this.style.backgroundColor='#1d4ed8'" 
                               onmouseout="this.style.backgroundColor='#2563eb'">
                                <i class="fa-solid fa-external-link-alt" style="margin-right: 8px;"></i>İlana Başvur
                            </a>`;
                        } else if (item.contact) {
                            // Manuel eklenen ilanlar
                            applyButton = `<div style="background-color: #f3f4f6; padding: 10px; border-radius: 8px; margin-top: 12px;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">İletişim Bilgileri:</div>
                                <div style="color: #2563eb; word-break: break-all;">${item.contact}</div>
                            </div>`;
                        }
                        
                        // Adzuna attribution - HER ZAMAN göster (Adzuna ilanları için zorunlu)
                        const attribution = item.source === 'adzuna' ? 
                            `<div style="background-color: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 12px; text-align: center; font-size: 12px;">
                                <img src="https://c.adzuna.com/logo/adzuna_logo_small.png" style="height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" alt="Adzuna">
                                <span style="color: #6b7280;">Powered by</span> 
                                <a href="https://www.adzuna.com" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 600;">Adzuna</a>
                            </div>` : '';
                        
                        popupContent = `<div class="custom-popup-container ${sponsoredPopupClass}">
                            <!-- İlan Başlığı -->
                            <div style="font-size: 18px; font-weight: bold; color: #0097A7; margin-bottom: 8px; line-height: 1.3;">
                                ${item.title}
                            </div>
                            
                            <!-- Şirket Adı -->
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center;">
                                <i class="fa-solid fa-building" style="margin-right: 8px; color: #6b7280; font-size: 14px;"></i>
                                ${item.company || item.name}
                            </div>
                            
                            <!-- Maaş Bilgisi -->
                            ${item.type === 'job' && (item.salary_min || item.salary_max) ? 
                                `<div style="font-size: 15px; font-weight: bold; color: #059669; margin-bottom: 12px; padding: 8px; background-color: #f0fdf4; border-radius: 6px; display: flex; align-items: center;">
                                    <i class="fa-solid fa-dollar-sign" style="margin-right: 8px; font-size: 14px;"></i>
                                    ${item.currency || 'USD'} ${item.salary_min?.toLocaleString() || '?'} - ${item.salary_max?.toLocaleString() || '?'}
                                    ${item.isRemote ? '<span style="color: #059669; margin-left: 8px;"><i class="fa-solid fa-house" style="margin-right: 4px; font-size: 12px;"></i>Remote</span>' : ''}
                                </div>` : 
                                item.isRemote ? '<div style="margin-bottom: 12px; color: #059669; font-weight: bold; padding: 8px; background-color: #f0fdf4; border-radius: 6px; display: flex; align-items: center;"><i class="fa-solid fa-house" style="margin-right: 8px; font-size: 14px;"></i>Remote İş</div>' : 
                                ''}
                            
                            <!-- Açıklama (İlk 150 karakter) -->
                            <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px; line-height: 1.4; border-left: 3px solid #e5e7eb; padding-left: 12px;">
                                ${item.description ? item.description.substring(0, 150) + (item.description.length > 150 ? '...' : '') : 'Açıklama mevcut değil.'}
                            </div>
                            
                            <!-- Lokasyon -->
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 16px; display: flex; align-items: center;">
                                <i class="fa-solid fa-location-dot" style="margin-right: 6px; color: #9ca3af;"></i>
                                ${item.address}
                            </div>
                            
                            <!-- Başvuru Butonu -->
                            ${applyButton}
                            
                            <!-- Adzuna Attribution -->
                            ${attribution}
                        </div>`;
                    } else {
                        popupContent = `<div class="custom-popup-container text-center">
                            <div class="font-bold text-lg ${item.type === 'job' ? 'text-ilan' : 'text-cv'}">${item.title}</div>
                            <div class="text-base font-semibold text-gray-800">${item.company || item.name}</div>
                            <p class="text-sm text-gray-600 my-2">Bu kayıt <b>50 km'lik ücretsiz alanınızın dışında</b> kaldığı için detayları gizlenmiştir. Tüm fırsatlara erişmek için abone olun.</p>
                            <button id="subscribe-btn-${item.id}" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Abonelik Seçenekleri</button>
                        </div>`;
                    }
                    
                    marker.bindPopup(popupContent);

                    marker.on('popupopen', () => {
                        if (!canView) {
                            const btn = document.getElementById(`subscribe-btn-${item.id}`);
                            if (btn) btn.onclick = onPremiumClick;
                        }
                    });

                    clusterGroupRef.current.addLayer(marker);
                });
            }, [data, isSubscribed, userLocation]);

            useEffect(() => {
                if (selectedLocation && mapInstance.current) {
                    mapInstance.current.flyTo([selectedLocation.lat, selectedLocation.lng], 18, { animate: true, duration: 1.5 });
                }
            }, [selectedLocation]);

            return (
                <div className="relative h-full w-full">
                    <div ref={mapRef} className="h-full w-full" />
                    {/* *** DEĞİŞİKLİK: Yeni kontrol paneli *** */}
                    <div className="absolute top-4 right-4 z-[1000] flex flex-col gap-2">
                        <button 
                            onClick={() => mapInstance.current && userLocation && mapInstance.current.flyTo([userLocation.lat, userLocation.lng], 14)} 
                            className="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-green-700"
                        >
                            Konum
                        </button>
                        <div className="bg-white rounded-lg shadow-lg flex">
                             <button onClick={() => changeMapLayer('street')} className="px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-l-lg">Sokak</button>
                             <button onClick={() => changeMapLayer('satellite')} className="px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-r-lg border-l">Uydu</button>
                        </div>
                    </div>
                </div>
            );
        }

        function FilterComponent({ onFilterChange, setCurrentPage, isSubscribed, onSubscribeToggle }) {
            const [localKeyword, setLocalKeyword] = useState('');
            const [localFilterType, setLocalFilterType] = useState('all');

            const handleFilter = () => {
                onFilterChange({ type: localFilterType, keyword: localKeyword });
                setCurrentPage(1);
            };

            const handleClear = () => {
                setLocalKeyword('');
                setLocalFilterType('all');
                onFilterChange({ type: 'all', keyword: '' });
                setCurrentPage(1);
            };

            return (
                <div className="mb-4">
                    <div className="flex flex-col sm:flex-row gap-4">
                        <div className="grid grid-cols-3 gap-2 flex-shrink-0">
                            <button onClick={() => setLocalFilterType('all')} className={`p-3 rounded-lg font-semibold text-sm ${localFilterType === 'all' ? 'bg-gray-800 text-white' : 'bg-gray-200'}`}>Tümü</button>
                            <button onClick={() => setLocalFilterType('job')} className={`p-3 rounded-lg font-semibold text-sm ${localFilterType === 'job' ? 'bg-ilan text-white' : 'bg-gray-200'}`}>İş İlanları</button>
                            <button onClick={() => setLocalFilterType('cv')} className={`p-3 rounded-lg font-semibold text-sm ${localFilterType === 'cv' ? 'bg-cv text-white' : 'bg-gray-200'}`}>Adaylar</button>
                        </div>
                        <div className="flex-grow flex gap-2">
                            <div className="relative flex-grow">
                                <input type="text" placeholder="Anahtar kelime ile ara..." value={localKeyword} onChange={e => setLocalKeyword(e.target.value)} className="w-full h-full p-3 pl-10 border rounded-lg" />
                                <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button onClick={handleFilter} className="bg-blue-600 text-white font-semibold px-4 rounded-lg hover:bg-blue-700">Filtrele</button>
                            <button onClick={handleClear} className="bg-gray-200 text-gray-700 font-semibold px-4 rounded-lg hover:bg-gray-300">Temizle</button>
                        </div>
                        {/* Abonelik Test Butonu */}
                        <label className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={isSubscribed} onChange={onSubscribeToggle} className="w-5 h-5" />
                            <span className="text-sm font-medium">Abone Olundu</span>
                        </label>
                    </div>
                </div>
            );
        }

        function ListComponent({ data, onRowClick, isSubscribed, userLocation, onPremiumClick }) {
            return (
                <div className="flex-grow overflow-y-auto">
                    {data.length === 0 ? (
                        <p className="text-center text-gray-500 mt-4">Filtrelerinize uygun sonuç bulunamadı.</p>
                    ) : (
                        <div className="w-full overflow-x-auto">
                            <table className="min-w-full bg-white text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Tür</th>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Başlık / Ünvan</th>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Firma / Aday</th>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Uzaklık</th>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Konum</th>
                                        <th className="p-3 text-left font-semibold text-gray-600 whitespace-nowrap">Aksiyonlar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map(item => {
                                        const distance = getDistance(userLocation.lat, userLocation.lng, item.location.lat, item.location.lng);
                                        const isPremiumContent = distance > 50;
                                        const canView = isSubscribed || !isPremiumContent;
                                        return (
                                            <tr key={item.id} className={`border-b align-top ${canView ? 'cursor-pointer' : 'opacity-70'} ${item.isSponsored ? 'bg-yellow-50 hover:bg-yellow-100' : (canView ? 'hover:bg-gray-100' : '')}`} onClick={() => canView ? onRowClick(item.location) : onPremiumClick()}>
                                                <td className="p-3">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold text-white ${item.type === 'job' ? 'bg-ilan' : 'bg-cv'}`}>{item.type === 'job' ? 'İLAN' : 'Aday'}</span>
                                                        {item.isSponsored && <span className="px-2 py-1 rounded-full text-xs font-semibold text-yellow-800 bg-yellow-200">Sponsorlu</span>}
                                                    </div>
                                                </td>
                                                <td className="p-3"><p className="font-bold">{item.title}</p><p className={`text-gray-600 text-xs mt-1 ${!canView && 'blur-sm'}`}>{item.description.substring(0, 70)}...</p></td>
                                                <td className={`p-3 text-gray-700 ${!canView && 'blur-sm'}`}>{item.company || item.name}</td>
                                                <td className={`p-3 text-gray-700 font-medium whitespace-nowrap ${!canView && 'blur-sm'}`}>{distance.toFixed(1)} km</td>
                                                <td className="p-3 text-gray-600">{item.address}</td>
                                                <td className="p-3">
                                                    <div className="flex justify-start gap-2 text-xs font-semibold">
                                                        {item.isOwner && (
                                                            <>
                                                                <button className="px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">Düzenle</button>
                                                                <button className="px-2 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200">Sil</button>
                                                            </>
                                                        )}
                                                        <button className="px-2 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Şikayet</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }
        
        function PaginationComponent({ currentPage, totalPages, onPageChange }) {
            const getPageNumbers = () => {
                const pageNumbers = [];
                const maxPagesToShow = 7;
                const halfPages = Math.floor(maxPagesToShow / 2);

                if (totalPages <= maxPagesToShow) {
                    for (let i = 1; i <= totalPages; i++) {
                        pageNumbers.push(i);
                    }
                } else {
                    pageNumbers.push(1);
                    if (currentPage > halfPages + 1) {
                        pageNumbers.push('...');
                    }

                    let start = Math.max(2, currentPage - halfPages + (currentPage > totalPages - halfPages ? totalPages - currentPage - halfPages + 1 : 0));
                    let end = Math.min(totalPages - 1, currentPage + halfPages - (currentPage <= halfPages ? currentPage - halfPages : 0));
                    
                    for (let i = start; i <= end; i++) {
                        pageNumbers.push(i);
                    }

                    if (currentPage < totalPages - halfPages) {
                        pageNumbers.push('...');
                    }
                    pageNumbers.push(totalPages);
                }
                return pageNumbers;
            };

            if (totalPages <= 1) return null;

            return (
                <div className="flex justify-center items-center gap-2 mt-4">
                    <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Önceki</button>
                    
                    {getPageNumbers().map((page, index) => 
                        typeof page === 'number' ? (
                            <button 
                                key={index}
                                onClick={() => onPageChange(page)}
                                className={`w-8 h-8 rounded-md ${currentPage === page ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}
                            >
                                {page}
                            </button>
                        ) : (
                            <span key={index} className="px-2 text-gray-500">...</span>
                        )
                    )}

                    <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Sonraki</button>
                </div>
            );
        }

        function SubscriptionModal({ onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[2000]">
                    <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm">
                        <i className="fa-solid fa-lock text-5xl text-yellow-500 mb-4"></i>
                        <h2 className="text-2xl font-bold mb-2">Premium Özellik</h2>
                        <p className="text-gray-600 mb-6">Bu kaydın tüm detaylarını görmek ve 50 km dışındaki tüm fırsatlara erişmek için abonelik planlarımızı inceleyin.</p>
                        <div className="flex flex-col gap-3">
                            <button className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Abonelik Seçeneklerini Gör</button>
                            <button onClick={onClose} className="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">Kapat</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
